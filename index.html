<!DOCTYPE html>
<html lang="en">
<head>
	<title>Aflamagn löndunarhafna</title>
	<script src="d3.v4.min.js" charset="utf-8"></script>
	<script src="topojson.v2.min.js"></script>
  <link rel="stylesheet" type="text/css" href="style.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
</head>
<body>
	<!-- Page elements and content go here. -->
	<script>
		// Width and Height of the whole visualization
var width = document.body.clientWidth, //window.innerWidth,
    height = window.innerHeight,
    centered, text, scale, circles, themax, render, tegundir;

// Global control variables
var selectedAr = 0; // 0 == 2016
var selectedTegund = "Alls";

// Create SVG
var svg = d3.select("body")
    .append("svg:svg")
    .attr("xmlns","http://www.w3.org/2000/svg")
    .attr("width", width)
    .attr("height", height);

// Rect for zoom on click
svg.append("svg:rect")
    .attr("class", "background")
    .attr("width", width)
    .attr("height", height)
    .on("click", clicked);

// Append empty placeholder g element to the SVG
// g will contain geometry elements
var g = svg.append("g");
var ports = null;

// Legend
var legend = svg.append("g");
  legend.append("rect").attr("x", height/16).attr("y", 64).attr("width", 350).attr("height", 800).attr("style", "fill: white;stroke-width:2;stroke:rgb(0,0,0); fill-opacity: 0.4;");
var formContainer = legend.append("svg:foreignObject").attr("width", 350).attr("height", 200).attr("x", height/16).attr("y", 64).append("xhtml:div").append("xhtml:form");

var legends = null;
 
function showText(d, circle) {
  text
    .attr("y", circle.cy.baseVal.value + 8 + "px")
    .attr("x", circle.cx.baseVal.value + 18 + "px")
    .text(d.properties.nafn + " (" + addDot(d.properties.afli) + " t.)")
    .style("visibility", "visible");
}

// Width and Height of the whole visualization
// Set Projection Parameters
var projection = d3.geoConicConformal()
  	.center([-1.0, 65])
	  .parallels([63, 68])
    .rotate([18, 0])
    .translate( [width/2,height/2] );

// Create GeoPath function that uses built-in D3 functionality to turn
// lat/lon coordinates into screen coordinates
var geoPath = d3.geoPath()
    .projection(projection);

d3.json("island-simple-1000000-topo.json", process);

function doLegend() {
  var data = [];
  var parts = 5;
  var increment = Math.floor(tegundir[selectedTegund][selectedAr].max/parts/Math.pow(10,Math.ceil(Math.log(tegundir[selectedTegund][selectedAr].max/parts + 1) / Math.LN10)-1))*Math.pow(10,Math.ceil(Math.log(tegundir[selectedTegund][selectedAr].max/parts + 1) / Math.LN10)-1);


  for(var i = 0; i < parts; i++)
    data[i] = (i+1)*increment;


  var legendUnit = tegundir[selectedTegund][selectedAr].scale(data[4])*2;
  legends = legend.selectAll(".legends").data(data, function(d,i) { return i;});

  legends
    .transition()
    .duration(500)
    .select("circle").attr("r", (d) => (tegundir[selectedTegund][selectedAr].scale(d)))
  legends.select("text").text((d) => addDot(d));

  var enter = legends.enter();
  var gl = enter.append("svg:g").classed("legends", true);
    gl.append("svg:circle")
    //.attr("fill", colors[i])
    .attr("r", (d) => (tegundir[selectedTegund][selectedAr].scale(d)))
    //.attr("height", height/16)
    .attr("cx", height/16 + legendUnit/2 + 15)
    .attr("cy", (d,i) => ((i+1) * legendUnit) + 170)
    gl.append("text")
    .attr("x", (height/10) + legendUnit/2)
    .attr("y", (d,i ) => ((i+1) * legendUnit) + 170)
    .attr("dx", "32")
    .attr("dy", "15")
    .attr("font-family", "arial")
    .attr("font-size", (height/48) + "px")        
    .text((d) => addDot(d)+' t.');

}

function processData(data)  {

  if(data)  { // Argument only provided on inital page load
    ports = svg.append("svg:g");
    themax = data.objects.hafnir.geometries;
    tegundir = data.objects.tegundir;

    var div1 = formContainer.append("xhtml:div").classed("col-auto my-1", true);
      div1.append("label").classed("mr-sm-2", true).text("Ár:");
    var div2 = formContainer.append("xhtml:div").classed("col-auto my-1", true);
      div2.append("label").classed("mr-sm-2", true).text("Fisktegund:")
    var select = div1.append("xhtml:select").classed("custom-select mr-sm-2", true).on("change", function(s) { selectedAr = this.selectedIndex; processData(); });
    var select2 = div2.append("xhtml:select").classed("custom-select mr-sm-2", true).on("change", function(s) { selectedTegund = this.options[this.selectedIndex].value; processData(); });


    for(var i = 0; i < 35; i++)  {
      select.append("option").text(2016-i)
    }

    var array = [];

    for(var key in data.objects.tegundir)  {
        var c = data.objects.tegundir[key];
        c.forEach(function(y){ y.scale = d3.scaleLinear().domain([y.min, y.max]).range([10, 60]);})
        array.push(key)

    }

    array.sort().forEach(function(k) { select2.append("option").text(k);});

    if(!text)
      text = svg.append("text").attr("font-size", "16pt");

  }
  
 render = themax.map((e) => ((e.properties.tegundir[selectedTegund]) ? {type:e.type, properties: {id: e.properties.id, hofn: e.properties.hofn, nafn: e.properties.nafn, afli : e.properties.tegundir[selectedTegund][selectedAr]}, geometry: e.geometry}: null));

 renderCircles(render.filter(function(d) { return (d && d.properties.afli > 0); }));

}

function renderCircles(data)  {  
  doLegend(); // Redo legend info

  // Start D3 General Update Pattern for fishery data
  circles = ports.selectAll("circle").data(data, function(d) { return d.properties.id;});

  circles.exit()
    .transition()
    .duration(1000)
    .attr("fill", "red")
    .attr("r", 1)
    .remove();

  circles
    .transition()
    .duration(1000)
    .attr("r", function(d) { return (d.properties.afli) ? tegundir[selectedTegund][selectedAr].scale(d.properties.afli): 0;});

  circles.enter()
    .append("circle")
    .on("click", clicked)
    .on("mouseover", function(d) { showText(d, this); })
    .on("mouseout", function(d) { text.style("visibility", "hidden");})
    .attr("opacity", "0.4")
    .attr("r", 1)
    .attr("cx", function(d) { return projection(d.geometry.coordinates)[0];})
    .attr("cy", function(d) { return projection(d.geometry.coordinates)[1];})
    .transition()
    .duration(1000)
    .attr("r", function(d) {  return (d.properties.afli) ? tegundir[selectedTegund][selectedAr].scale(d.properties.afli): 0;})
    .attr("fill", "black")
    .attr("stroke", "blue")
    .attr("stroke-width", "1px")
    .attr("class", "place");

}

// Helper function that returns an integer with dots between thousands
function addDot(n)   {
    return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
}

function process(data)	{
    var featureCollection = topojson.feature(data, data.objects["island-geo"]);

    // Compute the feature bounds and centroid
    // http://bl.ocks.org/pnavarrc/62047b5638d624cfa9cb
    var bounds = d3.geoBounds(featureCollection);//,
        //center = d3.geoCentroid(featureCollection);

    var distance = d3.geoDistance(bounds[0], bounds[1]);
        scale = height / distance;
   // console.log(distance)
    // Update the projection scale and centroid
    projection.scale(scale*1.3);


	g.selectAll( "path" )
    .data( featureCollection.features )
    //.data( data.features )
    .enter()
    .append( "path" )
    .attr( "fill", "mediumaquamarine")
    .attr( "stroke", "burlywood")
    .attr( "d", geoPath )

  d3.json("data.json", processData);

}


function prettyPercent(p, n)   {
    return Math.round(parseFloat(p) * Math.pow(10, n+2))/Math.pow(10,n);
}

// https://bl.ocks.org/mbostock/2206590

function clicked(d) {
  var x, y, k;

  if (d && centered !== d) {
    var centroid = geoPath.centroid(d);
    x = centroid[0];
    y = centroid[1];
    k = 4;
    centered = d;
  } else {
    x = width / 2;
    y = height / 2;
    k = 1;
    centered = null;
  }

  g.selectAll("path")
      .classed("active", centered && function(d) { return d === centered; });

  g.transition()
      .duration(750)
      .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")scale(" + k + ")translate(" + -x + "," + -y + ")");
      //.style("stroke-width", 1.5 / k + "px");
}

	</script>
</body>
</html>